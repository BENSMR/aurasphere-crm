# ğŸ¤– AI Automation & Cost Control - Architecture Diagram

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       USER INTERFACE                             â”‚
â”‚                 (Flutter Material Design 3)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           AI Automation Settings Page                    â”‚   â”‚
â”‚  â”‚        (/ai-automation route in main.dart)              â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚  [âš™ï¸ Master Toggle] [Automation: ON/OFF]                â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚  [ğŸ’° Budget Card] - Progress Bar - Status Indicator     â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚  [Proactivity Selector]                                 â”‚   â”‚
â”‚  â”‚  â€¢ ğŸ›¡ï¸ Conservative   â€¢ âš–ï¸ Balanced   â€¢ ğŸ”¥ Aggressive  â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚  [Agent Control Panel]                                  â”‚   â”‚
â”‚  â”‚  â€¢ CFO Agent   [Toggle] [Proactive]                    â”‚   â”‚
â”‚  â”‚  â€¢ CEO Agent   [Toggle] [Proactive]                    â”‚   â”‚
â”‚  â”‚  â€¢ Marketing   [Toggle] [Proactive]                    â”‚   â”‚
â”‚  â”‚  â€¢ Sales       [Toggle] [Proactive]                    â”‚   â”‚
â”‚  â”‚  â€¢ Admin       [Toggle] [Proactive]                    â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚  [Usage Analytics]                                      â”‚   â”‚
â”‚  â”‚  API Calls | Cost | Breakdown by Agent                â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚  [Cost Limit Settings]                                 â”‚   â”‚
â”‚  â”‚  Monthly Limit | Alert Threshold | Auto-Pause          â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â–²                                      â”‚
â”‚                           â”‚                                      â”‚
â”‚                    [Import & Navigate]                          â”‚
â”‚                           â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   Home Page      â”‚ â”€â”€â”€â”€â”˜     â”‚   Aura Chat Page     â”‚        â”‚
â”‚  â”‚  Settings Icon âš™ï¸â”‚           â”‚  (Updated with       â”‚        â”‚
â”‚  â”‚  Opens Settings  â”‚           â”‚   Quota Check)       â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                           â–²                      â”‚
â”‚                                           â”‚                      â”‚
â”‚                                  [Quota Check Before API]        â”‚
â”‚                                           â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                       â”‚                       â”‚
                    â–¼                       â–¼                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Settings Service â”‚    â”‚ Automation       â”‚    â”‚ Aura AI Service â”‚
        â”‚ (Read/Update)    â”‚    â”‚ Service          â”‚    â”‚ (API Calls)    â”‚
        â”‚                  â”‚    â”‚ (Core Logic)     â”‚    â”‚                â”‚
        â”‚ Methods:         â”‚    â”‚                  â”‚    â”‚ Methods:       â”‚
        â”‚ â€¢ Get settings   â”‚    â”‚ Manages:         â”‚    â”‚ â€¢ parseCommand â”‚
        â”‚ â€¢ Save settings  â”‚    â”‚ â€¢ Toggles        â”‚    â”‚ â€¢ executeActionâ”‚
        â”‚ â€¢ Handle errors  â”‚    â”‚ â€¢ Quotas         â”‚    â”‚                â”‚
        â”‚                  â”‚    â”‚ â€¢ Costs          â”‚    â”‚ (Uses Groq API)â”‚
        â”‚ (Database)       â”‚    â”‚ â€¢ Analytics      â”‚    â”‚ Via Edge Fn    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                       â”‚                       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                   â”‚                           â”‚
        â”‚         SUPABASE BACKEND          â”‚                           â”‚
        â”‚         (PostgreSQL Database)     â”‚                           â”‚
        â”‚                                   â”‚                           â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
        â”‚  â”‚       ai_automation_settings TABLE                 â”‚     â”‚
        â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
        â”‚  â”‚ id (UUID)                                          â”‚     â”‚
        â”‚  â”‚ org_id (FK) â”€â–º organizations                       â”‚     â”‚
        â”‚  â”‚ automation_enabled (BOOLEAN)                       â”‚     â”‚
        â”‚  â”‚ proactivity_level (TEXT)                           â”‚     â”‚
        â”‚  â”‚ agents (JSONB)                                     â”‚     â”‚
        â”‚  â”‚ monthly_api_limit (INTEGER)                        â”‚     â”‚
        â”‚  â”‚ monthly_cost_limit (DECIMAL)                       â”‚     â”‚
        â”‚  â”‚ cost_alert_threshold (DECIMAL)                     â”‚     â”‚
        â”‚  â”‚ auto_pause_on_limit (BOOLEAN)                      â”‚     â”‚
        â”‚  â”‚ created_at, updated_at                             â”‚     â”‚
        â”‚  â”‚                                                     â”‚     â”‚
        â”‚  â”‚ INDEXES:                                           â”‚     â”‚
        â”‚  â”‚ â€¢ org_id (UNIQUE)                                  â”‚     â”‚
        â”‚  â”‚                                                     â”‚     â”‚
        â”‚  â”‚ RLS POLICIES:                                      â”‚     â”‚
        â”‚  â”‚ â€¢ View: Org members only                           â”‚     â”‚
        â”‚  â”‚ â€¢ Update: Org owners only                          â”‚     â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
        â”‚                                                              â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
        â”‚  â”‚       ai_usage_log TABLE                         â”‚        â”‚
        â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
        â”‚  â”‚ id (UUID)                                        â”‚        â”‚
        â”‚  â”‚ org_id (FK)                                      â”‚        â”‚
        â”‚  â”‚ user_id (FK)                                     â”‚        â”‚
        â”‚  â”‚ agent_name (TEXT)                                â”‚        â”‚
        â”‚  â”‚ action (TEXT)                                    â”‚        â”‚
        â”‚  â”‚ tokens_used (INTEGER)                            â”‚        â”‚
        â”‚  â”‚ input_tokens (INTEGER)                           â”‚        â”‚
        â”‚  â”‚ output_tokens (INTEGER)                          â”‚        â”‚
        â”‚  â”‚ estimated_cost (DECIMAL)                         â”‚        â”‚
        â”‚  â”‚ timestamp (TIMESTAMP)                            â”‚        â”‚
        â”‚  â”‚                                                  â”‚        â”‚
        â”‚  â”‚ INDEXES:                                         â”‚        â”‚
        â”‚  â”‚ â€¢ org_id (Lookup)                                â”‚        â”‚
        â”‚  â”‚ â€¢ timestamp (Range queries)                      â”‚        â”‚
        â”‚  â”‚ â€¢ agent_name (Filtering)                         â”‚        â”‚
        â”‚  â”‚ â€¢ user_id (Analytics)                            â”‚        â”‚
        â”‚  â”‚                                                  â”‚        â”‚
        â”‚  â”‚ RLS POLICIES:                                    â”‚        â”‚
        â”‚  â”‚ â€¢ Select: Org members                            â”‚        â”‚
        â”‚  â”‚ â€¢ Insert: System/Backend only                    â”‚        â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
        â”‚                                                              â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
        â”‚  â”‚  VIEWS & FUNCTIONS                               â”‚        â”‚
        â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
        â”‚  â”‚ â€¢ ai_usage_monthly (VIEW)                        â”‚        â”‚
        â”‚  â”‚   - Groups usage by month                        â”‚        â”‚
        â”‚  â”‚   - Shows: calls, tokens, cost, agents           â”‚        â”‚
        â”‚  â”‚                                                  â”‚        â”‚
        â”‚  â”‚ â€¢ ai_usage_by_agent (VIEW)                       â”‚        â”‚
        â”‚  â”‚   - Groups by agent and month                    â”‚        â”‚
        â”‚  â”‚   - Shows: count, tokens, cost, avg              â”‚        â”‚
        â”‚  â”‚                                                  â”‚        â”‚
        â”‚  â”‚ â€¢ get_current_month_usage(orgId) FUNCTION        â”‚        â”‚
        â”‚  â”‚   - Returns: total_tokens, total_cost, api_calls â”‚        â”‚
        â”‚  â”‚                                                  â”‚        â”‚
        â”‚  â”‚ â€¢ is_org_over_cost_limit(orgId) FUNCTION         â”‚        â”‚
        â”‚  â”‚   - Returns: over_limit, current_cost, limit     â”‚        â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
        â”‚                                                              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow Diagram

### Flow 1: User Disables Agent

```
User                    UI                  Service             Database
â”‚                       â”‚                     â”‚                    â”‚
â”œâ”€â”€â–º Click Toggle â”€â”€â”€â”€â”€â”€â–ºâ”‚                     â”‚                    â”‚
â”‚                       â”‚ setAgentEnabled()   â”‚                    â”‚
â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
â”‚                       â”‚                     â”‚ UPDATE agents      â”‚
â”‚                       â”‚                     â”‚ JSONB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
â”‚                       â”‚                     â”‚                    â”‚
â”‚                       â”‚â—„â”€â”€â”€â”€â”€â”€ Success â”€â”€â”€â”€â”€â”¤                    â”‚
â”‚                       â”‚                     â”‚                    â”‚
â”‚â—„â”€ Toast Notification â”€â”¤                     â”‚                    â”‚
```

### Flow 2: API Call with Quota Check

```
User                    UI                Service            Database
â”‚                       â”‚                   â”‚                  â”‚
â”œâ”€ Type Message â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚                  â”‚
â”‚                       â”‚                   â”‚                  â”‚
â”‚                       â”‚ checkCallAllowed()â”‚                  â”‚
â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚
â”‚                       â”‚                   â”‚ SELECT settings  â”‚
â”‚                       â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
â”‚                       â”‚                   â”‚â—„â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       â”‚                   â”‚                  â”‚
â”‚                       â”‚                   â”‚ SELECT FROM      â”‚
â”‚                       â”‚                   â”‚ ai_usage_log     â”‚
â”‚                       â”‚                   â”‚ (current month)  â”‚
â”‚                       â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
â”‚                       â”‚                   â”‚â—„â”€ Usage Data â”€â”€â”€â”€â”¤
â”‚                       â”‚                   â”‚                  â”‚
â”‚                       â”‚ {allowed: true}   â”‚                  â”‚
â”‚                       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚
â”‚                       â”‚                   â”‚                  â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚              â”‚ IF ALLOWED, CONTINUE:               â”‚        â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                       â”‚                                       â”‚
â”‚                       â”‚ parseCommand(text, lang)             â”‚
â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚
â”‚                       â”‚        (Groq API via Edge Fn)       â”‚
â”‚                       â”‚                   â”‚                  â”‚
â”‚                       â”‚ executeAction(cmd)â”‚                  â”‚
â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚
â”‚                       â”‚        (DB update)â”‚                  â”‚
â”‚                       â”‚                   â”‚                  â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚              â”‚ LOG API CALL:                       â”‚        â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                       â”‚ logApiCall()                         â”‚
â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚
â”‚                       â”‚                   â”‚ INSERT INTO      â”‚
â”‚                       â”‚                   â”‚ ai_usage_log     â”‚
â”‚                       â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
â”‚                       â”‚                   â”‚ (tokens, cost)   â”‚
â”‚                       â”‚                   â”‚                  â”‚
â”‚                       â”‚ âœ… Success       â”‚                  â”‚
â”‚                       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚
â”‚                       â”‚                   â”‚                  â”‚
â”‚â—„â”€ Show Result â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                  â”‚
```

### Flow 3: Cost Limit Enforcement (Auto-Pause)

```
System                  Service             Database          Result
â”‚                       â”‚                     â”‚                â”‚
â”‚ Monthly Boundary      â”‚                     â”‚                â”‚
â”‚ (End of Month)        â”‚                     â”‚                â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚                     â”‚                â”‚
â”‚                 â”‚     â”‚ Monthly Job:        â”‚                â”‚
â”‚                 â””â”€â”€â”€â”€â–ºâ”‚ checkOrgLimits()    â”‚                â”‚
â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ SUM(cost) FROM â”‚
â”‚                       â”‚                     â”‚ ai_usage_log   â”‚
â”‚                       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”¤ WHERE month=.. â”‚
â”‚                       â”‚ Total: $150       â”‚ â”‚                â”‚
â”‚                       â”‚ Limit: $100       â”‚ â”‚                â”‚
â”‚                       â”‚ âœ“ OVER LIMIT â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
â”‚                       â”‚                       â”‚                â”‚
â”‚                       â”‚ setAutomationEnabled  â”‚                â”‚
â”‚                       â”‚ (orgId, false) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
â”‚                       â”‚                     â”‚ UPDATE          â”‚
â”‚                       â”‚                     â”‚ automation..    â”‚
â”‚                       â”‚                     â”‚ = false         â”‚
â”‚                       â”‚                     â”‚                â”‚
â”‚ Org Paused â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ Return: "Paused"  â”‚                â”‚
â”‚ Automation OFF        â”‚                     â”‚                â”‚
â”‚ (Next API call        â”‚                     â”‚                â”‚
â”‚  will be blocked)     â”‚                     â”‚                â”‚
```

---

## State Management Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    AIAutomationSettingsPage (StatefulWidget)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  State Variables:                                   â”‚
â”‚  â€¢ String orgId                                    â”‚
â”‚  â€¢ Map<String, dynamic> settings                   â”‚
â”‚  â€¢ Map<String, dynamic> usage                      â”‚
â”‚  â€¢ Map<String, dynamic> budget                     â”‚
â”‚  â€¢ String selectedProactivityLevel                 â”‚
â”‚  â€¢ bool loading = true                             â”‚
â”‚                                                    â”‚
â”‚  Lifecycle:                                        â”‚
â”‚  1. initState() â”€â”€â”€â”€â”                             â”‚
â”‚                     â”œâ”€â–º _initializePage()          â”‚
â”‚                     â”‚                              â”‚
â”‚                     â”œâ”€â–º Fetch org ID              â”‚
â”‚                     â”‚                              â”‚
â”‚                     â”œâ”€â–º getAutomationSettings()    â”‚
â”‚                     â”‚                              â”‚
â”‚                     â”œâ”€â–º getCurrentMonthUsage()     â”‚
â”‚                     â”‚                              â”‚
â”‚                     â””â”€â–º getRemainingBudget()       â”‚
â”‚                         setState() â”€â–º UI Updates   â”‚
â”‚                                                    â”‚
â”‚  User Interactions:                                â”‚
â”‚  â€¢ setAutomationEnabled()   â”€â–º setState() rebuild  â”‚
â”‚  â€¢ setProactivityLevel()    â”€â–º setState() rebuild  â”‚
â”‚  â€¢ setAgentEnabled()        â”€â–º setState() rebuild  â”‚
â”‚  â€¢ setAgentProactive()      â”€â–º setState() rebuild  â”‚
â”‚  â€¢ setMonthlyCostLimit()    â”€â–º setState() rebuild  â”‚
â”‚  â€¢ setAutoPauseOnLimit()    â”€â–º setState() rebuild  â”‚
â”‚                                                    â”‚
â”‚  Display:                                          â”‚
â”‚  â€¢ 7 Card widgets (each section)                  â”‚
â”‚  â€¢ Each card updates independently                â”‚
â”‚  â€¢ Color coding: Green/Orange/Red status          â”‚
â”‚  â€¢ Progress bars show usage %                     â”‚
â”‚                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Database Query Patterns

### Query 1: Get Current Settings
```sql
SELECT * FROM ai_automation_settings WHERE org_id = ?
â”œâ”€ Result: 1 row (settings JSONB includes agents)
â””â”€ Time: ~5ms (indexed on org_id)
```

### Query 2: Check If Over Limit
```sql
SELECT SUM(estimated_cost) as total
FROM ai_usage_log
WHERE org_id = ?
  AND date_trunc('month', timestamp) = date_trunc('month', NOW())
â”œâ”€ Result: Single aggregate value
â””â”€ Time: ~20ms (indexed on org_id, timestamp)
```

### Query 3: Get Usage Breakdown
```sql
SELECT agent_name, COUNT(*), SUM(estimated_cost)
FROM ai_usage_log
WHERE org_id = ?
  AND date_trunc('month', timestamp) = date_trunc('month', NOW())
GROUP BY agent_name
â”œâ”€ Result: 1-5 rows (per agent)
â””â”€ Time: ~50ms (grouped aggregation)
```

### Query 4: Get Usage Trend (7 days)
```sql
SELECT date_trunc('day', timestamp) as day, SUM(estimated_cost) as cost
FROM ai_usage_log
WHERE org_id = ?
  AND timestamp >= NOW() - INTERVAL '7 days'
GROUP BY date_trunc('day', timestamp)
â”œâ”€ Result: 1-7 rows (per day)
â””â”€ Time: ~30ms (range + grouping)
```

---

## Error Handling Flow

```
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  User Action (API Call) â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  checkCallAllowed()   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Try-Catch Block    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Check 1: Automation?â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Check 2: Agent OK? â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Check 3: Cost Limit?â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Check 4: Cost Alert?â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚                       â”‚
        â–¼                       â–¼                       â–¼
    FAIL 1              FAIL 2-4                   SUCCESS
    â”œâ”€â–º Log error       â”œâ”€â–º Show warning message  â”œâ”€â–º Continue
    â”œâ”€â–º Return {         â”œâ”€â–º Return {allowed:     â”œâ”€â–º Execute
    â”‚   allowed: false,  â”‚   false, reason: ...   â”‚   API call
    â”‚   reason: "..."}   â”‚   }                    â”œâ”€â–º Log usage
    â””â”€ Message to user   â””â”€ Block API call        â””â”€ Return result
```

---

## Cost Calculation Formula

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Cost Estimation for API Call           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  Input Tokens: 150 tokens                      â”‚
â”‚  Output Tokens: 100 tokens                     â”‚
â”‚                                                 â”‚
â”‚  Groq Pricing:                                 â”‚
â”‚  â€¢ Input:  $0.05 per 1M tokens                â”‚
â”‚  â€¢ Output: $0.15 per 1M tokens                â”‚
â”‚                                                 â”‚
â”‚  Calculation:                                  â”‚
â”‚                                                 â”‚
â”‚  Input Cost = (150 / 1,000,000) Ã— $0.05      â”‚
â”‚            = 0.00015 Ã— $0.05                  â”‚
â”‚            = $0.0000075                       â”‚
â”‚                                                 â”‚
â”‚  Output Cost = (100 / 1,000,000) Ã— $0.15     â”‚
â”‚             = 0.0001 Ã— $0.15                  â”‚
â”‚             = $0.000015                       â”‚
â”‚                                                 â”‚
â”‚  Total Cost = $0.0000075 + $0.000015          â”‚
â”‚            = $0.0000225                       â”‚
â”‚            â‰ˆ $0.00002 (rounded to 4 decimals) â”‚
â”‚                                                 â”‚
â”‚  Monthly Estimate (2000 calls @ 250 tokens):  â”‚
â”‚  = 2000 Ã— $0.00002                            â”‚
â”‚  = $0.04 (very low cost!)                     â”‚
â”‚                                                 â”‚
â”‚  Note: Actual tokens vary by prompt length    â”‚
â”‚  Estimate: $0.002 - $0.008 per call average   â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Component Interaction Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   AuraChatPage                             â”‚
â”‚  - Displays chat interface                                â”‚
â”‚  - Handles user input                                     â”‚
â”‚  - Shows agent selection cards                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                               â”‚
             â”‚ sendMessage()                 â”‚ switchAgent()
             â”‚                               â”‚
             â–¼                               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ AIAutomation   â”‚            â”‚ Agent Selector   â”‚
    â”‚ Service        â”‚            â”‚ UI               â”‚
    â”‚                â”‚            â”‚                  â”‚
    â”‚ Methods:       â”‚            â”‚ 5 Agent Cards    â”‚
    â”‚ â€¢ checkCallOK  â”‚            â”‚ â€¢ CFO (Green)    â”‚
    â”‚ â€¢ logApiCall   â”‚            â”‚ â€¢ CEO (Blue)     â”‚
    â”‚ â€¢ Quota checks â”‚            â”‚ â€¢ Mkting (Orange)â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ â€¢ Sales (Purple) â”‚
             â”‚                    â”‚ â€¢ Admin (Red)    â”‚
             â”‚ Enforces quotas    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ Logs usage
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Supabase Database      â”‚
    â”‚                        â”‚
    â”‚ â€¢ Settings table       â”‚
    â”‚ â€¢ Usage log table      â”‚
    â”‚ â€¢ Views & functions    â”‚
    â”‚ â€¢ RLS Policies         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Quota Enforcement Decision Tree

```
                        API Call Request
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Automation       â”‚
                    â”‚ Enabled?         â”‚
                    â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
                    YESâ”‚              â”‚NO
                       â”‚              â–¼
                       â”‚          âŒ BLOCK
                       â”‚      "Automation disabled"
                       â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Agent Enabled?      â”‚
            â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
            YESâ”‚              â”‚NO
               â”‚              â–¼
               â”‚          âŒ BLOCK
               â”‚      "Agent disabled"
               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Cost Limit Set?     â”‚
    â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    YESâ”‚              â”‚NO
       â”‚              â–¼
       â”‚          âœ… ALLOW
       â”‚         (No limit)
       â”‚
    â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Current Cost <      â”‚
    â”‚ Monthly Limit?      â”‚
    â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    YESâ”‚              â”‚NO
       â”‚              â–¼
       â”‚          âŒ BLOCK
       â”‚     "Limit reached"
       â”‚     Auto-pause if enabled
       â”‚
    â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Usage > 80% Limit?  â”‚
    â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    YESâ”‚              â”‚NO
       â”‚              â–¼
       â”‚          âœ… ALLOW
       â”‚        (No alert)
       â”‚
       â–¼
   âš ï¸ ALERT
   "Cost alert: 80% of budget used"
   (Still allow the call)
   â”‚
   â–¼
 âœ… ALLOW
   Continue with API call
```

---

This architecture provides:
âœ… **Clear separation of concerns** - UI, service, database layers
âœ… **Efficient queries** - Indexed lookups, aggregations
âœ… **Secure by default** - RLS policies on all tables
âœ… **Scalable design** - Pre-aggregated views for analytics
âœ… **User-friendly** - Clear error messages, status indicators
âœ… **Cost-effective** - Prevents abuse with quota enforcement
